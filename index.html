<html>
<head>
    <title>INFO/CS 3300 - Project 2 (asz35, hju3, lgd34)</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,600" rel="stylesheet">
    <style>
        body {
            font-family: 'Fira Sans', sans-serif;
        }

        .bold {
            font-weight: 600;
        }

        .light {
            font-weight: 300;
        }

        .no-pointer {
            pointer-events:none;
        }

        .year {
            font-size: 36px;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #ddd;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            cursor: pointer;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }

        .button {
            fill: none;
            stroke: gray;
            stroke-width: 1px;
        }

    </style>
</head>
<body>
<svg width="800px" height="700px" class="mainSvg"></svg>
<svg width="450px" height="700px" id="buttons"></svg>
<script>
    var svg = d3.select(".mainSvg")

    var currentState = "New York";
    var currentYear = 2016;

    var stateAvg = {};
    var tempDiffByYear = {};
    var disastersByYear = {};
    var disasterData = {};
    var disasterIncidents = [];
    var stateIncidents = [];

    var gridMap;
    var gridMapDict = {};

    var tempScale;

    var currentSetting;

    // Climate data from NOAA: https://www7.ncdc.noaa.gov/CDO/CDODivisionalSelect.jsp
    // Disaster data from: https://www.fema.gov/disasters/grid/year
    // Gridmap data used from: https://github.com/kristw/gridmap-layout-usa
    // (with MIT license)
    d3.queue()
    .defer(d3.csv, "data/climate/climate.csv", function(row) {
        return { year: Number(row["Year"]), state: row["State"], temp: Number(row["Avg Temperature Index"])};
    })
    .defer(d3.csv, "data/disasters/disasters.csv", function(row) {
        return { year: Number(row["Date"]), state: row["State"], incident: row["Incident Description"]};
    })
    .defer(d3.csv, "data/gridmap-layout-usa.csv")
    .await( function (error, climateDataRaw, disasterDataRaw, gridMapRaw) {
        // Compute average climate data - visualization will be based on difference from average
        climateDataRaw.forEach(function(d) {
            if( d.state in stateAvg )
                stateAvg[d.state] += d.temp;
            else
                stateAvg[d.state] = d.temp
        });
        for( state in stateAvg )
            stateAvg[state] /= 61;

        // Ideally we wouldn't have to iterate again but we need the average to compute the diff from average
        climateDataRaw.forEach(function(d) {
            if( !(d.state in tempDiffByYear) )
                tempDiffByYear[d.state] = {}
            tempDiffByYear[d.state][d.year] = diffFromAvg(d);
        });

        // Determine the color scale (based on temperature)
        // Color scheme derived from color brewer
        var maxTempDiff = d3.max(climateDataRaw, diffFromAvg);
        var minTempDiff = d3.min(climateDataRaw, diffFromAvg);
        tempScale = d3.scaleQuantize()
            .domain([minTempDiff, maxTempDiff])
            .range(['#2166ac','#4393c3','#92c5de','#d1e5f0','#f7f7f7','#fddbc7','#f4a582','#d6604d','#b2182b']);

        // Compute the number of disasters per year for each state
        disasterData = disasterDataRaw;
        disasterDataRaw.forEach(function(d) {
            if( !(d.state in disastersByYear) ) {
                disastersByYear[d.state] = {}
                for (i = 1956; i <= 2016; i += 1)
                    disastersByYear[d.state][i] = 0
            }
            disastersByYear[d.state][d.year] += 1 
        });

        // Store the map
        gridMap = gridMapRaw;
        for(i = 0; i < gridMap.length; i++) 
            gridMapDict[gridMap[i].name] = i;

        drawMap();
        drawSlider();
        drawButtons();

    });

    function diffFromAvg(climateRow) {
        return climateRow.temp - stateAvg[climateRow.state];
    }

    function getDisasterIncidents(year, option) {
        option = option || "All";
        disasterIncidents = [];
        index = 0;
        while (disasterData[index].year != year) {index += 1;}

        if (option == "All") {
            while (disasterData[index].year == year) {
                disasterIncidents.push(disasterData[index]);
                if (index == disasterData.length - 1) {break;}
                index += 1;
            }
        } else {
            while (disasterData[index].year == year) {
                if (disasterData[index].incident == option) {disasterIncidents.push(disasterData[index]);}
                if (index == disasterData.length - 1) {break;}
                index += 1;
            }
        }
    }

    function getStateDisasters(year, state) {
        stateIncidents = [];
        index = 0
        while (disasterData[index].year != year) {index += 1;}
        while (disasterData[index].year == year) {
            if (disasterData[index].state == state) {stateIncidents.push(disasterData[index]);}
            if (index == disasterData.length - 1) {break;}
            index += 1;
        }

    }

    function drawMap() {
        var states = svg.selectAll(".state-circles")
            .data(gridMap);

        getDisasterIncidents(currentYear, currentSetting);
        states.enter().append("circle")
                .attr("class", "state-circles")
                .attr("cx", function(d) {return d.x * 64 + 60;})
                .attr("cy", function(d) {return d.y * 64 + 60;})
                .attr("id", function(d) {return d.name;})
                .attr("r", 30)
                .on("mouseover", function(d) {
                    var newRadius = 30;

                    updateText(this.id);
                    if(disastersByYear[this.id][currentYear] > 4) {
                        this.parentElement.appendChild(this);
                        newRadius = insertIcons(this.id, true);
                        console.log(newRadius);
                    }

                    d3.select(this).transition().duration(200)
                        .attr("r", newRadius)
                        .style("cursor", "pointer")
                        .style("stroke", "#333333")
                        .style("stroke-width", "3px");
                })
                .on("mouseout", function() {
                    updateText(this.id);
                    if(disastersByYear[this.id][currentYear] > 4)
                        insertIcons(this.id, false);

                    d3.select(this).transition().duration(200)
                        .attr("r", 30)
                        .style("stroke", function() {
                            if (disastersByYear[this.id][currentYear] > 4)
                                return "#d40505";
                            else 
                                return "#dddddd";
                        })
                        .style("stroke-width", function() {
                            if (disastersByYear[this.id][currentYear] > 4) {
                                return "3px";
                            }
                            else {return "1px";}
                        });
                })
                .style("fill", function(d) {
                    return "#ffffff";
                })
            .merge(states)
                .transition(200)
                .style("fill", function() {
                    return tempScale(tempDiffByYear[this.id][currentYear]);
                })
                .style("stroke", function() {
                    if (disastersByYear[this.id][currentYear] > 4)
                        return "#d40505";
                    else
                        return "#dddddd";
                })
                .style("stroke-width", function(d) {
                    if (disastersByYear[this.id][currentYear] > 4) {
                        return "3px";
                    }
                });
        
        populateIcons();
    }

    function populateIcons() {
        d3.selectAll(".state-icons").remove();

        gridMap.forEach(function(d) {
            insertIcons(d.name, false);
        });
    }

    function insertIcons(state, expanded) {
        getStateDisasters(currentYear, state);

        var stateID = "state" + gridMapDict[state].toString();
        removeIcons(state);

        if(!expanded && stateIncidents.length > 4)
            stateIncidents = stateIncidents.slice(0, 4);

        var offset = 30;
        if(expanded)
            offset = 0;

        var diameter = 60;
        if(expanded)
            diameter = 120;

        // Arrange disasters in the circle by packing
        // Initialize parameters for packing
        var pack = d3.pack()
        .size([diameter, diameter])
        .radius(function() { return 10; })
        .padding(3);

        // Pack is heirarchy and thus needs a root node, so we append one
        stateIncidents.push({incident: "root"});
        var stratify = d3.stratify()
        .id(function(d) {
            return d.incident;
        })
        .parentId(function(d) { 
            if (d.incident == "root") {
                return null;
            }
            else
                return "root";
        });

        // Convert data to a heirarchical format
        var root = stratify(stateIncidents);
        pack(root);

        // Now that the data is formatted correctly, get rid of the root to make
        // the circle pack look nice
        var disasterNodes = root.descendants();
        disasterNodes.shift();

        var allDisasters = svg.selectAll("." + stateID)
            .data(disasterNodes);

        allDisasters.enter().append("svg:image")
            .attr("xlink:href", function(d) {
                if (d.id == "Fire") {return "images/fire.png";}
                else if (d.id == "Winter Storm") {return "images/winterstorm.png";}
                else if (d.id == "Drought") {return "images/drought.png";}
                else if (d.id == "Tropical Storm") {return "images/tropicalstorm.png";}
                else if (d.id == "Severe Storm/Flooding") {return "images/severestorm.png";}
                else {return "images/other.png";}

            })
            .attr("x", function(d) {
                return gridMap[gridMapDict[state]].x * 64 + 50;
            })
            .attr("y", function(d) {
                return gridMap[gridMapDict[state]].y * 64 + 50;
            })
            .attr("class", "no-pointer state-icons " + stateID)
            .style("opacity", 0.7)
            .attr("height", 18)
            .attr("width", 18);

        d3.selectAll("." + stateID).transition().duration(200)
            .attr("x", function(d) {
                return gridMap[gridMapDict[state]].x * 64 + d.x - 9 + offset;
            })
            .attr("y", function(d) {
                return gridMap[gridMapDict[state]].y * 64 + d.y - 9 + offset;
            });

        // Determine the pack radius
        return d3.max(disasterNodes, function (d) {
            var x = Math.abs(d.x);
            var y = Math.abs(d.y);
            return Math.sqrt(x * x + y * y);
        }) - 58;
    }

    function removeIcons(state) {
        var stateID = "state" + gridMapDict[state].toString();

        d3.selectAll("." + stateID).transition().duration(200)
            .attr("x", function(d) {
                return gridMap[gridMapDict[state]].x * 64 + 50;
            })
            .attr("y", function(d) {
                return gridMap[gridMapDict[state]].y * 64 + 50;
            });

        d3.selectAll("." + stateID).remove();
    }

    function updateText(state) {
        stateText.text(state);
        
        var tempDiff = tempDiffByYear[state][currentYear];
        if( tempDiff < 0 )
            tempText.text(d3.format(".2f")(-1 * tempDiff) + " degrees below state average");
        else
            tempText.text(d3.format(".2f")(tempDiff) + " degrees above state average");

        disasterText.text(function() {
            var numDisasters = disastersByYear[state][currentYear];
            if( numDisasters == 1 )
                return numDisasters + " disaster";
            else
                return numDisasters + " disasters";
        });
    }


    //year slider
    function drawSlider() {
        var x = d3.scaleLinear()
            .domain([1956, 2016])
            .range([0, 350])
            .clamp(true);
        var yearText = svg.append("text")
            .text("2016")
            .attr("class", "bold year")
            .attr("transform", "translate(47,580)");
        var slider = svg.append("g")
            .attr("class", "slider")
            .attr("transform", "translate(50,600)");
    
        slider.append("line")
            .attr("class", "track")
            .attr("x1", 0)
            .attr("x2", 350)
            .attr("stroke-linecap", "round")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-inset")
            .attr("stroke-linecap", "round")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-overlay")
            .attr("stroke-linecap", "round")
            .call(d3.drag()
            .on("start.interrupt", function() { slider.interrupt(); })
            .on("start drag", function() { year(Math.floor(x.invert(d3.event.x))); }));


        var handle = slider.insert("circle", ".track-overlay")
        .attr("cx", x(currentYear))
        .attr("class", "handle")
        .attr("r", 9)
        
        function year(y) {
            handle.attr("cx", x(y));
            yearText.text(y);
            currentYear = y;
            drawMap();
        }
    }

    //state info
    var stateText = svg.append("text")
        .attr("class", "bold")
        .attr("transform", "translate(550,575)");
    var tempText = svg.append("text")
        .attr("class", "light")
        .attr("transform", "translate(550,600)");
    var disasterText = svg.append("text")
        .attr("class", "light")
        .attr("transform", "translate(550,625)");

    // actual physical buttons
    function drawButtons() {
        var fire = d3.select("#buttons").append("rect")
            .attr("class", "button")
            .attr("height", 40)
            .attr("width", 180)
            .attr("x", 35)
            .attr("y", 125);

            fireButtonText.text("Fire");

        var winter = d3.select("#buttons").append("rect")
            .attr("class", "button")
            .attr("height", 40)
            .attr("width", 180)
            .attr("x", 35)
            .attr("y", 175);

            winterButtonText.text("Winter Storm");

        var drought = d3.select("#buttons").append("rect")
            .attr("class", "button")
            .attr("height", 40)
            .attr("width", 180)
            .attr("x", 35)
            .attr("y", 225);

            droughtButtonText.text("Drought");

        var tropical = d3.select("#buttons").append("rect")
            .attr("class", "button")
            .attr("height", 40)
            .attr("width", 180)
            .attr("x", 35)
            .attr("y", 275);

            tropicalButtonText.text("Tropical Storm");

        var severe = d3.select("#buttons").append("rect")
            .attr("class", "button")
            .attr("height", 40)
            .attr("width", 180)
            .attr("x", 35)
            .attr("y", 325);

            severeButtonText.text("Severe Storm/Flooding");

        var other = d3.select("#buttons").append("rect")
            .attr("class", "button")
            .attr("height", 40)
            .attr("width", 180)
            .attr("x", 35)
            .attr("y", 375);

            otherButtonText.text("Other");

        var reset = d3.select("#buttons").append("rect")
            .attr("class", "button")
            .attr("height", 40)
            .attr("width", 180)
            .attr("x", 35)
            .attr("y", 425);

            resetButtonText.text("Reset");
         
    }

    // text + controlling icons
    var fireButtonText = d3.select("#buttons").append("text")
        .attr("transform", "translate(125, 148)")
        .attr("text-anchor", "middle")
        .on("click", function(d) {
            getDisasterIncidents(currentYear, "Fire");
            currentSetting = "Fire";
            populateIcons();
        });
    var winterButtonText = d3.select("#buttons").append("text")
        .attr("transform", "translate(125, 200)")
        .attr("text-anchor", "middle")
        .on("click", function(d) {
            getDisasterIncidents(currentYear, "Winter Storm");
            currentSetting = "Winter Storm";
            populateIcons();
        });
    var droughtButtonText = d3.select("#buttons").append("text")
        .attr("transform", "translate(125, 248)")
        .attr("text-anchor", "middle")
        .on("click", function(d) {
            getDisasterIncidents(currentYear, "Drought");
            currentSetting = "Drought";
            populateIcons();
        });
    var tropicalButtonText = d3.select("#buttons").append("text")
        .attr("transform", "translate(125, 300)")
        .attr("text-anchor", "middle")
        .on("click", function(d) {
            getDisasterIncidents(currentYear, "Tropical Storm");
            currentSetting = "Tropical Storm";
            populateIcons();
        });
    var severeButtonText = d3.select("#buttons").append("text")
        .attr("transform", "translate(125, 348)")
        .attr("text-anchor", "middle")
        .on("click", function(d) {
            getDisasterIncidents(currentYear, "Severe Storm/Flooding");
            currentSetting = "Severe Storm/Flooding";
            populateIcons();
        });
    var otherButtonText = d3.select("#buttons").append("text")
        .attr("transform", "translate(125, 400)")
        .attr("text-anchor", "middle")
        .on("click", function(d) {
            getDisasterIncidents(currentYear, "Other");
            currentSetting = "Other";
            populateIcons();
        });
    var resetButtonText = d3.select("#buttons").append("text")
        .attr("transform", "translate(125, 448)")
        .attr("text-anchor", "middle")
        .on("click", function(d) {
            getDisasterIncidents(currentYear, "All");
            currentSetting = "All";
            populateIcons();
        });
</script>
</body>