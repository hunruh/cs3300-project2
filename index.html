<html>
<head>
    <title>INFO/CS 3300 - Project 2 (asz35, hju3, lgd34)</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,600" rel="stylesheet">
    <style>
        body {
            font-family: 'Fira Sans', sans-serif;
        }

        .bold {
            font-weight: 600;
        }

        .light {
            font-weight: 300;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #ddd;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            cursor: pointer;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }

        svg {
            border: solid #ccc 1px;
        }
    </style>
</head>
<body>
<svg width="800px" height="700px"></svg>
<script>
    var currentState = "New York";
    var currentYear = 2016;

    var stateAvg = {};
    var tempDiffByYear = {};
    var disastersByYear = {};

    var disasterDataG = {};
    var disasterIncidents = [];

    var gridMap;

    var tempScale;

    // Climate data from NOAA: https://www7.ncdc.noaa.gov/CDO/CDODivisionalSelect.jsp
    // Disaster data from: https://www.fema.gov/disasters/grid/year
    // Gridmap data used from: https://github.com/kristw/gridmap-layout-usa
    // (with MIT license)
    d3.queue()
    .defer(d3.csv, "data/climate/climate.csv", function(row) {
        return { year: Number(row["Year"]), state: row["State"], temp: Number(row["Avg Temperature Index"])};
    })
    .defer(d3.csv, "data/disasters/disasters.csv", function(row) {
        return { year: Number(row["Date"]), state: row["State"], incident: row["Incident Description"]};
    })
    .defer(d3.csv, "data/gridmap-layout-usa.csv")
    .await( function (error, climateData, disasterData, gridMapData) {
        // Compute average climate data - visualization will be based on difference from average
        climateData.forEach(function(d) {
            if( d.state in stateAvg )
                stateAvg[d.state] += d.temp;
            else
                stateAvg[d.state] = d.temp
        });
        for( state in stateAvg )
            stateAvg[state] /= 61;

        // Ideally we wouldn't have to iterate again but we need the average to compute the diff from average
        climateData.forEach(function(d) {
            if( !(d.state in tempDiffByYear) )
                tempDiffByYear[d.state] = {}
            tempDiffByYear[d.state][d.year] = diffFromAvg(d);
        });

        // Determine the color scale (based on temperature)
        // Color scheme derived from color brewer
        var maxTempDiff = d3.max(climateData, diffFromAvg);
        var minTempDiff = d3.min(climateData, diffFromAvg);

        tempScale = d3.scaleQuantize()
            .domain([minTempDiff, maxTempDiff])
            .range(['#2166ac','#4393c3','#92c5de','#d1e5f0','#f7f7f7','#f4a582','#fddbc7','#d6604d','#b2182b']);

        console.log(maxTempDiff);
        console.log(tempScale(3));
        console.log(tempScale(minTempDiff));

        // Compute the number of disasters per year for each state

        disasterDataG = disasterData;
        disasterData.forEach(function(d) {
            if( !(d.state in disastersByYear) ) {
                disastersByYear[d.state] = {}
                for (i = 1956; i <= 2016; i += 1)
                    disastersByYear[d.state][i] = 0
            }
            disastersByYear[d.state][d.year] += 1 
        });

        // Store the map
        gridMap = gridMapData;

        drawMap();
        insertIcons();
        drawSlider();
    });

    function diffFromAvg(climateRow) {
        return climateRow.temp - stateAvg[climateRow.state];
    }

    function getDisasterIncidents(year) {
        disasterIncidents = [];
        index = 0;
        while (disasterDataG[index].year != year) {index += 1;}

        while (disasterDataG[index].year == year) {
            disasterIncidents.push(disasterDataG[index]);
            if (index == disasterDataG.length - 1) {break;}
            index += 1;
        }
    }

    function drawMap() {
        var mapSVG = d3.select("svg");
        var states = mapSVG.selectAll("circle")
            .data(gridMap);

        getDisasterIncidents(currentYear);
        states.enter().append("circle")
                .attr("cx", function(d) {return d.x * 63 + 60;})
                .attr("cy", function(d) {return d.y * 63 + 60;})
                .attr("id", function(d) {return d.name;})
                .attr("r", 30)
                .on("mouseover", function(d) {
                    updateText(d.name);
                    d3.select(this).transition().duration(200)
                        .style("stroke", function(d) {
                            if (disastersByYear[d.name][currentYear] > 4) {
                                return "#32CD32";
                            }
                            else {return "#222222";}
                    })
                        .style("stroke-width", "3px");
                })
                .on("mouseout", function(d) {
                    updateText(d.name);
                    d3.select(this).transition().duration(200)
                        .style("stroke", function(d) {
                            if (disastersByYear[d.name][currentYear] > 4) {
                                return "#32CD32";
                            }
                            else {return "#eeeeee";}
                        })
                        .style("stroke-width", function(d) {
                            if (disastersByYear[d.name][currentYear] > 4) {
                                return "3px";
                            }
                            else {return "1px";}
                        });
                })
                .on("click", function(d) {
                    currentState = d.name;
                })
                .style("stroke", "#eeeeee")
                .style("fill", function(d) {
                    return "#ffffff";
                })
            .merge(states)
                .transition().duration(500)
                .style("fill", function(d) {
                    return tempScale(tempDiffByYear[d.name][currentYear]);
                })
                .style("stroke", function(d) {
                    if (disastersByYear[d.name][currentYear] > 4) {
                        return "#32CD32";
                    }
                })
                .style("stroke-width", function(d) {
                    if (disastersByYear[d.name][currentYear] > 4) {
                        return "3px";
                    }
                });
        
        insertIcons();
    }
    
    // Fire icon from: http://mikearteaga.com/wp-content/uploads/2017/02/passion.png
    // Winter Storm icon from: https://cdn4.iconfinder.com/data/icons/vectory-weather-1/40/snowflake-512.png
    // Drought icon from: https://d30y9cdsu7xlg0.cloudfront.net/png/597004-200.png
    // Tropical Storm icon from: https://d30y9cdsu7xlg0.cloudfront.net/png/22802-200.png
    // Severe Storm/Flooding icon from: http://www.freeiconspng.com/free-images/thunderstorm-icon-15897
    // Other icon from: http://www.freeiconspng.com/free-images/question-icon-26826    
    function insertIcons() {    
        //getDisasterIncidents(currentYear);
        d3.selectAll("image").remove();
        var iconSVG = d3.select("svg");
        var allDisasters = iconSVG.selectAll("image")
            .data(disasterIncidents);

        var statesAlreadyUsedX = [];
        var statesAlreadyUsedY = [];

        allDisasters.enter().append("svg:image")
            .attr("xlink:href", function(d) {
                if (d.incident == "Fire") {return "images/fire.png";}
                else if (d.incident == "Winter Storm") {return "images/winterstorm.png";}
                else if (d.incident == "Drought") {return "images/drought.png";}
                else if (d.incident == "Tropical Storm") {return "images/tropicalstorm.png";}
                else if (d.incident == "Severe Storm/Flooding") {return "images/severestorm.png";}
                else {return "images/other.png";}

            })
            .attr("x", function(d) {
                var mIndex = 0;
                while (gridMap[mIndex].name != d.state) {mIndex += 1;}
                if ( !(d.state in statesAlreadyUsedX) ) {
                    statesAlreadyUsedX[d.state] = 1;
                    return gridMap[mIndex].x * 63 + 35;
                }
                else if (statesAlreadyUsedX[d.state] < 4) {
                    statesAlreadyUsedX[d.state] += 1;
                    if (statesAlreadyUsedX[d.state] == 3 || statesAlreadyUsedX[d.state] == 4) {
                        return gridMap[mIndex].x * 63 + 60;
                    }
                    else {return gridMap[mIndex].x * 63 + 35;}
                }
                else {return 0;}
            })
            .attr("y", function(d) {
                var mIndex = 0;
                while (gridMap[mIndex].name != d.state) {mIndex += 1;}
                if ( !(d.state in statesAlreadyUsedY) ) {
                    statesAlreadyUsedY[d.state] = 1;
                    return gridMap[mIndex].y * 63 + 60;
                }
                else if (statesAlreadyUsedY[d.state] < 4) {
                    statesAlreadyUsedY[d.state] += 1;
                    if (statesAlreadyUsedY[d.state] == 2 || statesAlreadyUsedY[d.state] == 4) {
                        return gridMap[mIndex].y * 63 + 40;
                    }
                    else {return gridMap[mIndex].y * 63 + 60;}
                }
            })
            .attr("width", 20)
            .attr("height", 20); // GET RID OF THE ICONS IN THE CORNER

    }

    function updateText(state) {
        stateText.text(state);
        
        var tempDiff = tempDiffByYear[state][currentYear];
        if( tempDiff < 0 )
            tempText.text(d3.format(".2f")(-1 * tempDiff) + " degrees below average");
        else
            tempText.text(d3.format(".2f")(tempDiff) + " degrees above average");

        disasterText.text(function() {
            var numDisasters = disastersByYear[state][currentYear];
            if( numDisasters == 1 )
                return numDisasters + " disaster";
            else
                return numDisasters + " disasters";
        });
    }

    //year slider
    var svg = d3.select("svg")
    function drawSlider() {
        var x = d3.scaleLinear()
            .domain([1956, 2016])
            .range([0, 350])
            .clamp(true);
        var yearLabel = svg.append("text")
            .text("Year:")
            .attr("class", "light")
            .attr("transform", "translate(47,580)");
        var yearText = svg.append("text")
            .text("2016")
            .attr("class", "bold")
            .attr("transform", "translate(87,580)");
        var slider = svg.append("g")
            .attr("class", "slider")
            .attr("transform", "translate(50,600)");
    
        slider.append("line")
            .attr("class", "track")
            .attr("x1", 0)
            .attr("x2", 350)
            .attr("stroke-linecap", "round")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-inset")
            .attr("stroke-linecap", "round")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-overlay")
            .attr("stroke-linecap", "round")
            .call(d3.drag()
            .on("start.interrupt", function() { slider.interrupt(); })
            .on("start drag", function() { year(Math.floor(x.invert(d3.event.x))); }));


        var handle = slider.insert("circle", ".track-overlay")
        .attr("cx", x(currentYear))
        .attr("class", "handle")
        .attr("r", 9)
        
        function year(y) {
            handle.attr("cx", x(y));
            yearText.text(y);
            currentYear = y;
            drawMap();

        }
    }

    
    
    //state info
    var stateText = svg.append("text")
        .attr("class", "bold")
        .attr("transform", "translate(550,575)");
    var tempText = svg.append("text")
        .attr("class", "light")
        .attr("transform", "translate(550,600)");
    var disasterText = svg.append("text")
        .attr("class", "light")
        .attr("transform", "translate(550,625)");
</script>
</body>